<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Control Panel | BANKNIFTY / NIFTY</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg-primary:#0a0e17;--bg-secondary:#111827;--bg-tertiary:#1f2937;--bg-card:#1a1f2e;--bg-hover:#252d3d;
            --text-primary:#f9fafb;--text-secondary:#9ca3af;--text-muted:#6b7280;
            --accent-green:#10b981;--accent-green-dim:rgba(16,185,129,0.2);
            --accent-red:#ef4444;--accent-red-dim:rgba(239,68,68,0.2);
            --accent-yellow:#f59e0b;--accent-yellow-dim:rgba(245,158,11,0.2);
            --accent-blue:#3b82f6;--accent-blue-dim:rgba(59,130,246,0.2);
            --accent-purple:#8b5cf6;--border-color:#374151;--border-light:#4b5563;
        }
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;overflow-x:hidden}
        .dashboard{display:grid;grid-template-rows:auto 1fr auto;height:100vh;max-height:100vh;overflow:hidden}
        .header{background:var(--bg-secondary);border-bottom:1px solid var(--border-color);padding:12px 16px;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;z-index:100}
        .header-left,.header-center,.header-right{display:flex;align-items:center;gap:16px}
        .logo{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:8px}
        .symbol-selector{display:flex;background:var(--bg-tertiary);border-radius:8px;padding:2px}
        .symbol-btn{padding:8px 16px;border:none;background:transparent;color:var(--text-secondary);font-weight:600;font-size:0.875rem;cursor:pointer;border-radius:4px;transition:150ms ease}
        .symbol-btn.active{background:var(--accent-blue);color:var(--text-primary)}
        .symbol-btn:hover:not(.active){background:var(--bg-hover);color:var(--text-primary)}
        .mode-selector{display:flex;gap:8px}
        .mode-btn{padding:8px 12px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);font-size:0.8rem;font-weight:500;cursor:pointer;border-radius:4px;transition:150ms ease;display:flex;align-items:center;gap:4px}
        .mode-btn.active{border-color:var(--accent-green);color:var(--accent-green);background:var(--accent-green-dim)}
        .mode-btn.replay.active{border-color:var(--accent-yellow);color:var(--accent-yellow);background:var(--accent-yellow-dim)}
        .datetime-picker{display:none;align-items:center;gap:8px}
        .datetime-picker.visible{display:flex}
        .datetime-input{padding:8px 12px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);font-size:0.8rem;border-radius:4px}
        .status-container{display:flex;align-items:center;gap:16px;font-size:0.8rem}
        .status-item{display:flex;align-items:center;gap:4px}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--accent-green);animation:pulse 2s infinite}
        .status-dot.offline{background:var(--accent-red);animation:none}
        .status-dot.replay{background:var(--accent-yellow);animation:none}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
        .vix-badge{padding:4px 8px;border-radius:4px;font-weight:600;font-size:0.75rem}
        .vix-low{background:var(--accent-green-dim);color:var(--accent-green)}
        .vix-normal{background:var(--accent-blue-dim);color:var(--accent-blue)}
        .vix-high{background:var(--accent-yellow-dim);color:var(--accent-yellow)}
        .vix-extreme{background:var(--accent-red-dim);color:var(--accent-red)}
        .main-content{display:grid;grid-template-columns:1fr 320px;gap:1px;background:var(--border-color);overflow:hidden}
        .chart-section{background:var(--bg-primary);display:flex;flex-direction:column;overflow:hidden}
        .chart-toolbar{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-bottom:1px solid var(--border-color)}
        .overlay-toggles{display:flex;gap:4px}
        .overlay-btn{padding:4px 8px;border:1px solid var(--border-color);background:transparent;color:var(--text-muted);font-size:0.7rem;font-weight:500;cursor:pointer;border-radius:4px;transition:150ms ease}
        .overlay-btn.active{border-color:var(--accent-purple);color:var(--accent-purple);background:rgba(139,92,246,0.1)}
        .chart-info{display:flex;align-items:center;gap:12px;font-size:0.75rem;color:var(--text-secondary)}
        .price-display{font-size:1.1rem;font-weight:700}
        .price-display.up{color:var(--accent-green)}
        .price-display.down{color:var(--accent-red)}
        .price-change{font-size:0.8rem;padding:2px 6px;border-radius:4px}
        .price-change.up{background:var(--accent-green-dim);color:var(--accent-green)}
        .price-change.down{background:var(--accent-red-dim);color:var(--accent-red)}
        .chart-container{flex:1;position:relative;min-height:300px}
        #price-chart{width:100%;height:100%}
        .replay-controls{display:none;align-items:center;justify-content:center;gap:12px;padding:8px 12px;background:var(--bg-secondary);border-top:1px solid var(--border-color)}
        .replay-controls.visible{display:flex}
        .replay-btn{padding:8px 12px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);font-size:0.875rem;cursor:pointer;border-radius:4px;transition:150ms ease}
        .replay-btn:hover{background:var(--bg-hover);border-color:var(--border-light)}
        .replay-btn:disabled{opacity:0.5;cursor:not-allowed}
        .replay-time{font-size:0.875rem;color:var(--text-secondary);min-width:100px;text-align:center}
        .replay-speed{display:flex;align-items:center;gap:4px;font-size:0.75rem;color:var(--text-muted)}
        .right-panel{background:var(--bg-secondary);display:flex;flex-direction:column;overflow:hidden}
        .panel-tabs{display:flex;border-bottom:1px solid var(--border-color)}
        .panel-tab{flex:1;padding:12px;border:none;background:transparent;color:var(--text-muted);font-size:0.8rem;font-weight:600;cursor:pointer;transition:150ms ease;border-bottom:2px solid transparent}
        .panel-tab.active{color:var(--text-primary);border-bottom-color:var(--accent-blue)}
        .panel-tab:hover:not(.active){color:var(--text-secondary);background:var(--bg-hover)}
        .panel-content{flex:1;overflow:hidden;display:none}
        .panel-content.active{display:flex;flex-direction:column}
        .alert-list{flex:1;overflow-y:auto;padding:8px}
        .alert-item{padding:12px;margin-bottom:8px;background:var(--bg-card);border-radius:8px;border-left:3px solid var(--border-color);cursor:pointer;transition:150ms ease}
        .alert-item:hover{background:var(--bg-hover)}
        .alert-item.selected{background:var(--bg-hover);border-left-color:var(--accent-blue)}
        .alert-item.bullish{border-left-color:var(--accent-green)}
        .alert-item.bearish{border-left-color:var(--accent-red)}
        .alert-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .alert-time{font-size:0.75rem;color:var(--text-muted)}
        .alert-confidence{font-size:0.7rem;font-weight:600;padding:2px 6px;border-radius:4px}
        .conf-high{background:var(--accent-green-dim);color:var(--accent-green)}
        .conf-medium{background:var(--accent-yellow-dim);color:var(--accent-yellow)}
        .conf-low{background:var(--accent-red-dim);color:var(--accent-red)}
        .alert-body{display:flex;justify-content:space-between;align-items:center}
        .alert-symbol{font-weight:600;font-size:0.875rem}
        .alert-action{font-size:0.75rem;font-weight:600;padding:4px 8px;border-radius:4px}
        .action-buy{background:var(--accent-green-dim);color:var(--accent-green)}
        .action-sell{background:var(--accent-red-dim);color:var(--accent-red)}
        .action-wait{background:var(--bg-tertiary);color:var(--text-muted)}
        .alert-meta{display:flex;gap:8px;margin-top:4px;font-size:0.7rem;color:var(--text-muted)}
        .alert-tag{padding:1px 4px;background:var(--bg-tertiary);border-radius:2px}
        .context-panel{padding:12px}
        .context-section{margin-bottom:16px}
        .context-title{font-size:0.75rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px}
        .context-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .context-item{padding:8px;background:var(--bg-card);border-radius:4px}
        .context-label{font-size:0.7rem;color:var(--text-muted);margin-bottom:2px}
        .context-value{font-size:0.8rem;font-weight:600}
        .context-value.bullish{color:var(--accent-green)}
        .context-value.bearish{color:var(--accent-red)}
        .context-value.neutral{color:var(--text-secondary)}
        .signal-strength{margin-top:12px}
        .strength-bar-container{height:8px;background:var(--bg-tertiary);border-radius:4px;overflow:hidden;margin-top:4px}
        .strength-bar{height:100%;border-radius:4px;transition:width 0.5s ease}
        .strength-bar.high{background:var(--accent-green)}
        .strength-bar.medium{background:var(--accent-yellow)}
        .strength-bar.low{background:var(--accent-red)}
        .trade-decision{padding:12px;background:var(--bg-card);border-radius:8px;text-align:center;margin-top:12px}
        .decision-label{font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;margin-bottom:4px}
        .decision-value{font-size:1.1rem;font-weight:700}
        .decision-value.trade{color:var(--accent-green)}
        .decision-value.wait{color:var(--accent-yellow)}
        .decision-value.avoid{color:var(--accent-red)}
        .bottom-panel{display:grid;grid-template-columns:300px 1fr 350px;gap:1px;background:var(--border-color);border-top:1px solid var(--border-color)}
        .bottom-section{background:var(--bg-secondary);padding:12px}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .section-title{font-size:0.8rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px}
        .paper-trade-status{padding:12px;background:var(--bg-card);border-radius:8px;margin-bottom:12px}
        .trade-status-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .trade-position{font-weight:600;font-size:0.875rem}
        .trade-position.long{color:var(--accent-green)}
        .trade-position.short{color:var(--accent-red)}
        .trade-position.flat{color:var(--text-muted)}
        .trade-details{font-size:0.75rem;color:var(--text-secondary)}
        .trade-pnl{font-size:1rem;font-weight:700;margin-top:8px}
        .trade-pnl.profit{color:var(--accent-green)}
        .trade-pnl.loss{color:var(--accent-red)}
        .paper-trade-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .trade-btn{padding:8px 12px;border:none;font-size:0.8rem;font-weight:600;cursor:pointer;border-radius:4px;transition:150ms ease}
        .trade-btn:disabled{opacity:0.5;cursor:not-allowed}
        .trade-btn.buy-ce{background:var(--accent-green);color:white}
        .trade-btn.buy-ce:hover:not(:disabled){background:#0ea271}
        .trade-btn.buy-pe{background:var(--accent-red);color:white}
        .trade-btn.buy-pe:hover:not(:disabled){background:#dc2626}
        .trade-btn.exit{grid-column:span 2;background:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border-color)}
        .trade-btn.exit:hover:not(:disabled){background:var(--bg-hover)}
        .paper-trade-disabled{text-align:center;padding:16px;color:var(--text-muted);font-size:0.8rem}
        .analytics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
        .stat-card{padding:12px;background:var(--bg-card);border-radius:8px;text-align:center}
        .stat-value{font-size:1.25rem;font-weight:700}
        .stat-value.positive{color:var(--accent-green)}
        .stat-value.negative{color:var(--accent-red)}
        .stat-label{font-size:0.7rem;color:var(--text-muted);margin-top:2px}
        .distribution-container{display:flex;gap:16px;margin-top:12px}
        .distribution-chart{width:80px;height:80px;position:relative}
        .distribution-legend{flex:1;display:flex;flex-direction:column;justify-content:center;gap:4px}
        .legend-item{display:flex;align-items:center;gap:8px;font-size:0.75rem}
        .legend-dot{width:10px;height:10px;border-radius:50%}
        .alert-detail{padding:12px;background:var(--bg-card);border-radius:8px;height:100%;overflow-y:auto}
        .alert-detail-empty{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:0.875rem}
        .alert-detail-content{display:none}
        .alert-detail-content.visible{display:block}
        .detail-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;padding-bottom:12px;border-bottom:1px solid var(--border-color)}
        .detail-symbol{font-size:1.1rem;font-weight:700}
        .detail-action{font-size:0.875rem;font-weight:600;padding:4px 8px;border-radius:4px}
        .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .detail-item{padding:8px;background:var(--bg-tertiary);border-radius:4px}
        .detail-label{font-size:0.7rem;color:var(--text-muted)}
        .detail-value{font-size:0.8rem;font-weight:500;margin-top:2px}
        .detail-message{margin-top:12px;padding:12px;background:var(--bg-tertiary);border-radius:4px;font-size:0.8rem;color:var(--text-secondary);line-height:1.5}
        .no-data{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text-muted);font-size:0.875rem}
        .hidden{display:none!important}
        @media(max-width:1200px){.main-content{grid-template-columns:1fr 280px}.bottom-panel{grid-template-columns:1fr 1fr}.bottom-section:last-child{grid-column:span 2}}
        @media(max-width:900px){.header{flex-direction:column;align-items:stretch}.header-left,.header-center,.header-right{justify-content:center}.main-content{grid-template-columns:1fr;grid-template-rows:1fr auto}.right-panel{max-height:300px}.bottom-panel{grid-template-columns:1fr}.bottom-section:last-child{grid-column:auto}.analytics-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:600px){.bottom-panel{display:none}.chart-container{min-height:250px}}
    </style>
</head>
<body>
    <div class="dashboard">
        <header class="header">
            <div class="header-left">
                <div class="logo"><span>üìä</span><span>Trading Control Panel</span></div>
                <div class="symbol-selector">
                    <button class="symbol-btn active" data-symbol="BANKNIFTY">BANKNIFTY</button>
                    <button class="symbol-btn" data-symbol="NIFTY">NIFTY</button>
                </div>
            </div>
            <div class="header-center">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="live"><span>üî¥</span> LIVE</button>
                    <button class="mode-btn replay" data-mode="replay"><span>üìº</span> REPLAY</button>
                </div>
                <div class="datetime-picker" id="datetime-picker">
                    <input type="date" class="datetime-input" id="replay-date">
                    <input type="time" class="datetime-input" id="replay-from" value="09:15">
                    <span style="color:var(--text-muted)">to</span>
                    <input type="time" class="datetime-input" id="replay-to" value="15:30">
                    <button class="replay-btn" id="load-replay-btn">Load</button>
                </div>
            </div>
            <div class="header-right">
                <div class="status-container">
                    <div class="status-item"><span class="status-dot" id="status-dot"></span><span id="status-text">Connecting...</span></div>
                    <div class="status-item"><span style="color:var(--text-muted)">Last:</span><span id="last-update">--:--:--</span></div>
                    <div class="status-item"><span style="color:var(--text-muted)">VIX:</span><span class="vix-badge vix-normal" id="vix-badge">--</span></div>
                </div>
            </div>
        </header>
        <main class="main-content">
            <section class="chart-section">
                <div class="chart-toolbar">
                    <div class="overlay-toggles">
                        <button class="overlay-btn active" data-overlay="ema9">EMA 9</button>
                        <button class="overlay-btn active" data-overlay="ema21">EMA 21</button>
                        <button class="overlay-btn" data-overlay="ema50">EMA 50</button>
                        <button class="overlay-btn" data-overlay="vwap">VWAP</button>
                        <button class="overlay-btn active" data-overlay="alerts">Alerts</button>
                    </div>
                    <div class="chart-info">
                        <span id="chart-symbol">BANKNIFTY</span>
                        <span class="price-display up" id="current-price">--</span>
                        <span class="price-change up" id="price-change">--</span>
                    </div>
                </div>
                <div class="chart-container"><div id="price-chart"></div></div>
                <div class="replay-controls" id="replay-controls">
                    <button class="replay-btn" id="replay-start">‚èÆ Start</button>
                    <button class="replay-btn" id="replay-prev">‚óÄ Prev</button>
                    <button class="replay-btn" id="replay-play">‚ñ∂ Play</button>
                    <button class="replay-btn" id="replay-next">Next ‚ñ∂</button>
                    <button class="replay-btn" id="replay-end">End ‚è≠</button>
                    <span class="replay-time" id="replay-time">--:--</span>
                    <div class="replay-speed"><span>Speed:</span><select id="replay-speed" class="datetime-input"><option value="2000">0.5x</option><option value="1000" selected>1x</option><option value="500">2x</option><option value="250">4x</option></select></div>
                </div>
            </section>
            <aside class="right-panel">
                <div class="panel-tabs">
                    <button class="panel-tab active" data-panel="alerts">Alerts</button>
                    <button class="panel-tab" data-panel="context">Context</button>
                </div>
                <div class="panel-content active" id="panel-alerts">
                    <div class="alert-list" id="alert-list"><div class="no-data">Loading alerts...</div></div>
                </div>
                <div class="panel-content" id="panel-context">
                    <div class="context-panel">
                        <div class="context-section">
                            <div class="context-title">Market Regime</div>
                            <div class="context-grid">
                                <div class="context-item"><div class="context-label">Regime</div><div class="context-value neutral" id="ctx-regime">--</div></div>
                                <div class="context-item"><div class="context-label">Direction</div><div class="context-value neutral" id="ctx-direction">--</div></div>
                            </div>
                        </div>
                        <div class="context-section">
                            <div class="context-title">Sector Alignment</div>
                            <div class="context-grid">
                                <div class="context-item"><div class="context-label">Banking</div><div class="context-value neutral" id="ctx-banking">--</div></div>
                                <div class="context-item"><div class="context-label">NBFC</div><div class="context-value neutral" id="ctx-nbfc">--</div></div>
                            </div>
                        </div>
                        <div class="context-section">
                            <div class="context-title">Market Conditions</div>
                            <div class="context-grid">
                                <div class="context-item"><div class="context-label">VIX State</div><div class="context-value neutral" id="ctx-vix">--</div></div>
                                <div class="context-item"><div class="context-label">Depth Bias</div><div class="context-value neutral" id="ctx-depth">--</div></div>
                            </div>
                        </div>
                        <div class="signal-strength">
                            <div class="context-title">Signal Strength</div>
                            <div style="display:flex;justify-content:space-between;align-items:center"><span style="color:var(--text-muted);font-size:0.75rem">Confidence</span><span id="ctx-confidence" style="font-weight:600">--%</span></div>
                            <div class="strength-bar-container"><div class="strength-bar medium" id="strength-bar" style="width:0%"></div></div>
                        </div>
                        <div class="trade-decision"><div class="decision-label">Trade Decision</div><div class="decision-value wait" id="trade-decision">WAIT</div></div>
                    </div>
                </div>
            </aside>
        </main>
        <footer class="bottom-panel">
            <section class="bottom-section">
                <div class="section-header"><span class="section-title">Paper Trading</span><span style="color:var(--text-muted);font-size:0.7rem" id="paper-mode-label">SIMULATION</span></div>
                <div id="paper-trade-container">
                    <div class="paper-trade-status" id="paper-trade-status">
                        <div class="trade-status-header"><span class="trade-position flat" id="paper-position">NO POSITION</span><span style="color:var(--text-muted);font-size:0.7rem" id="paper-entry-time">--</span></div>
                        <div class="trade-details"><span>Entry: </span><span id="paper-entry-price">--</span><span> | Current: </span><span id="paper-current-price">--</span></div>
                        <div class="trade-pnl" id="paper-pnl">‚Çπ0</div>
                    </div>
                    <div class="paper-trade-buttons">
                        <button class="trade-btn buy-ce" id="btn-buy-ce" disabled>üìà BUY CE</button>
                        <button class="trade-btn buy-pe" id="btn-buy-pe" disabled>üìâ BUY PE</button>
                        <button class="trade-btn exit hidden" id="btn-exit" disabled>‚úñ EXIT TRADE</button>
                    </div>
                    <div class="paper-trade-disabled" id="paper-trade-disabled"><p>‚ö†Ô∏è Paper trading API not available</p><p style="font-size:0.7rem;margin-top:4px">Simulation mode active in REPLAY</p></div>
                </div>
            </section>
            <section class="bottom-section">
                <div class="section-header"><span class="section-title">Session Analytics</span><span style="color:var(--text-muted);font-size:0.7rem" id="session-date">--</span></div>
                <div class="analytics-grid">
                    <div class="stat-card"><div class="stat-value" id="stat-total-alerts">0</div><div class="stat-label">Total Alerts</div></div>
                    <div class="stat-card"><div class="stat-value" id="stat-avg-confidence">0%</div><div class="stat-label">Avg Confidence</div></div>
                    <div class="stat-card"><div class="stat-value positive" id="stat-buy-alerts">0</div><div class="stat-label">Buy Signals</div></div>
                    <div class="stat-card"><div class="stat-value negative" id="stat-sell-alerts">0</div><div class="stat-label">Sell Signals</div></div>
                </div>
                <div class="distribution-container">
                    <div class="distribution-chart"><canvas id="distribution-canvas" width="80" height="80"></canvas></div>
                    <div class="distribution-legend" id="distribution-legend">
                        <div class="legend-item"><span class="legend-dot" style="background:var(--accent-green)"></span><span>BUY_CE: <span id="legend-buy-ce">0</span></span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:var(--accent-red)"></span><span>BUY_PE: <span id="legend-buy-pe">0</span></span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:var(--accent-yellow)"></span><span>SELL: <span id="legend-sell">0</span></span></div>
                        <div class="legend-item"><span class="legend-dot" style="background:var(--text-muted)"></span><span>WAIT: <span id="legend-wait">0</span></span></div>
                    </div>
                </div>
            </section>
            <section class="bottom-section">
                <div class="section-header"><span class="section-title">Alert Details</span></div>
                <div class="alert-detail">
                    <div class="alert-detail-empty" id="alert-detail-empty">Click an alert to view details</div>
                    <div class="alert-detail-content" id="alert-detail-content">
                        <div class="detail-header">
                            <div><div class="detail-symbol" id="detail-symbol">--</div><div style="color:var(--text-muted);font-size:0.75rem" id="detail-time">--</div></div>
                            <div class="detail-action action-buy" id="detail-action">--</div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-item"><div class="detail-label">Confidence</div><div class="detail-value" id="detail-confidence">--%</div></div>
                            <div class="detail-item"><div class="detail-label">Priority</div><div class="detail-value" id="detail-priority">--</div></div>
                            <div class="detail-item"><div class="detail-label">OI Category</div><div class="detail-value" id="detail-oi">--</div></div>
                            <div class="detail-item"><div class="detail-label">Depth Bias</div><div class="detail-value" id="detail-depth">--</div></div>
                            <div class="detail-item"><div class="detail-label">Regime</div><div class="detail-value" id="detail-regime">--</div></div>
                            <div class="detail-item"><div class="detail-label">VIX State</div><div class="detail-value" id="detail-vix">--</div></div>
                        </div>
                        <div class="detail-message" id="detail-message">No additional context available.</div>
                    </div>
                </div>
            </section>
        </footer>
    </div>
    <script>
const CONFIG={API_BASE:window.location.hostname==='localhost'||window.location.hostname==='127.0.0.1'?'http://localhost:8000':`http://${window.location.hostname}:8000`,LIVE_POLL_INTERVAL:30000,COLORS:{ema9:'#3b82f6',ema21:'#8b5cf6',ema50:'#f59e0b',vwap:'#ec4899',buyMarker:'#10b981',sellMarker:'#ef4444'}};
const AppState={mode:'live',symbol:'BANKNIFTY',chart:null,candleSeries:null,ema9Series:null,ema21Series:null,ema50Series:null,vwapSeries:null,candles:[],alerts:[],analytics:null,marketDirection:null,sectors:[],overlays:{ema9:true,ema21:true,ema50:false,vwap:false,alerts:true},replay:{data:[],currentIndex:0,isPlaying:false,playInterval:null,speed:1000},paperTrade:{position:null,entryPrice:0,entryTime:null,trades:[]},selectedAlert:null,pollTimer:null,isConnected:false,lastUpdate:null};

function formatTime(d){if(!d)return'--:--';const t=d.includes('T')?d.split('T')[1]:d.split(' ')[1];return t?t.substring(0,5):'--:--'}
function formatDateTime(d){return d?d.substring(0,16).replace('T',' '):'--'}
function formatPrice(p){return p==null?'--':'‚Çπ'+Number(p).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2})}
function formatPnL(p){return(p>=0?'+':'')+p.toFixed(2)+' pts'}
function getConfidenceClass(c){return c>=70?'conf-high':c>=55?'conf-medium':'conf-low'}
function getActionClass(a){if(!a)return'action-wait';if(a.includes('BUY_CE')||a.includes('LONG'))return'action-buy';if(a.includes('BUY_PE')||a.includes('SHORT')||a.includes('SELL'))return'action-sell';return'action-wait'}
function getContextClass(v){if(!v)return'neutral';const u=v.toUpperCase();if(u.includes('BUY')||u.includes('BULLISH')||u.includes('UP')||u.includes('LONG')||u.includes('LOW'))return'bullish';if(u.includes('SELL')||u.includes('BEARISH')||u.includes('DOWN')||u.includes('SHORT')||u.includes('HIGH')||u.includes('EXTREME'))return'bearish';return'neutral'}
function parseTimestamp(ts){if(!ts)return null;return new Date(ts.replace(' ','T')).getTime()/1000}
function getTodayDate(){return new Date().toISOString().split('T')[0]}

async function fetchAPI(e){try{const r=await fetch(`${CONFIG.API_BASE}${e}`);if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.json()}catch(err){console.error(`API Error (${e}):`,err);return null}}
async function fetchDashboardSummary(){return await fetchAPI('/dashboard/summary')}
async function fetchCandles(s,h=6){return await fetchAPI(`/timeseries/candles/${s}?hours=${h}`)}
async function fetchAlerts(l=50){return await fetchAPI(`/alerts/latest?limit=${l}`)}
async function fetchAlertsByTime(f,t){const d=await fetchAPI(`/alerts/by_time?from=${f}&to=${t}`);if(!d){const a=await fetchAlerts(100);return a?a.filter(x=>{const at=x.time||x.timestamp_ist;return at>=f&&at<=t}):[]}return d}

function initChart(){const c=document.getElementById('price-chart');c.innerHTML='';AppState.chart=LightweightCharts.createChart(c,{layout:{background:{type:'solid',color:'#0a0e17'},textColor:'#9ca3af'},grid:{vertLines:{color:'#1f2937'},horzLines:{color:'#1f2937'}},crosshair:{mode:LightweightCharts.CrosshairMode.Normal},rightPriceScale:{borderColor:'#374151'},timeScale:{borderColor:'#374151',timeVisible:true,secondsVisible:false}});
AppState.candleSeries=AppState.chart.addCandlestickSeries({upColor:'#10b981',downColor:'#ef4444',borderUpColor:'#10b981',borderDownColor:'#ef4444',wickUpColor:'#10b981',wickDownColor:'#ef4444'});
AppState.ema9Series=AppState.chart.addLineSeries({color:CONFIG.COLORS.ema9,lineWidth:1,title:'EMA 9',visible:AppState.overlays.ema9});
AppState.ema21Series=AppState.chart.addLineSeries({color:CONFIG.COLORS.ema21,lineWidth:1,title:'EMA 21',visible:AppState.overlays.ema21});
AppState.ema50Series=AppState.chart.addLineSeries({color:CONFIG.COLORS.ema50,lineWidth:1,title:'EMA 50',visible:AppState.overlays.ema50});
AppState.vwapSeries=AppState.chart.addLineSeries({color:CONFIG.COLORS.vwap,lineWidth:1,lineStyle:2,title:'VWAP',visible:AppState.overlays.vwap});
window.addEventListener('resize',()=>{AppState.chart.applyOptions({width:c.clientWidth,height:c.clientHeight})});
AppState.chart.applyOptions({width:c.clientWidth,height:c.clientHeight})}

function updateChart(candles,analytics=[]){if(!AppState.candleSeries||!candles||candles.length===0)return;
const cc=candles.map(c=>({time:parseTimestamp(c.time_minute||c.time),open:c.open,high:c.high,low:c.low,close:c.close})).filter(c=>c.time).sort((a,b)=>a.time-b.time);
AppState.candleSeries.setData(cc);
if(analytics&&analytics.length>0){const e9=[],e21=[],e50=[],vw=[];analytics.forEach(a=>{const t=parseTimestamp(a.time_minute||a.time);if(!t)return;if(a.ema_9_value)e9.push({time:t,value:a.ema_9_value});if(a.ema_21_value)e21.push({time:t,value:a.ema_21_value});if(a.ema_50_value)e50.push({time:t,value:a.ema_50_value});if(a.vwap_value)vw.push({time:t,value:a.vwap_value})});
[e9,e21,e50,vw].forEach(arr=>arr.sort((a,b)=>a.time-b.time));AppState.ema9Series.setData(e9);AppState.ema21Series.setData(e21);AppState.ema50Series.setData(e50);AppState.vwapSeries.setData(vw)}else{calcEMAs(cc)}
if(AppState.overlays.alerts)addAlertMarkers();
if(cc.length>0){const l=cc[cc.length-1],p=cc.length>1?cc[cc.length-2]:l;updatePriceDisplay(l.close,p.close)}
AppState.chart.timeScale().fitContent()}

function calcEMAs(candles){if(candles.length<9)return;const cl=candles.map(c=>c.close);
const calcEMA=(pr,pd)=>{const k=2/(pd+1);let sum=0;for(let i=0;i<pd;i++)sum+=pr[i];let ema=sum/pd;const arr=[ema];for(let i=pd;i<pr.length;i++){ema=pr[i]*k+ema*(1-k);arr.push(ema)}return arr};
const e9=calcEMA(cl,9),e21=calcEMA(cl,21),e50=calcEMA(cl,50);
AppState.ema9Series.setData(e9.map((v,i)=>({time:candles[i+8]?.time,value:v})).filter(d=>d.time));
AppState.ema21Series.setData(e21.map((v,i)=>({time:candles[i+20]?.time,value:v})).filter(d=>d.time));
AppState.ema50Series.setData(e50.map((v,i)=>({time:candles[i+49]?.time,value:v})).filter(d=>d.time))}

function addAlertMarkers(){if(!AppState.candleSeries||!AppState.alerts)return;
const m=AppState.alerts.filter(a=>(a.symbol===AppState.symbol||a.symbol===AppState.symbol+'_FUT')).map(a=>{const t=parseTimestamp(a.time||a.timestamp_ist);if(!t)return null;const act=a.recommended_action||a.alert_type||'';const isBuy=act.includes('BUY_CE')||act.includes('LONG')||act.includes('LB')||act.includes('SC');return{time:t,position:isBuy?'belowBar':'aboveBar',color:isBuy?CONFIG.COLORS.buyMarker:CONFIG.COLORS.sellMarker,shape:isBuy?'arrowUp':'arrowDown',text:`${a.confidence||''}%`}}).filter(Boolean).sort((a,b)=>a.time-b.time);
AppState.candleSeries.setMarkers(m)}

function updatePriceDisplay(cur,prev){const pEl=document.getElementById('current-price'),cEl=document.getElementById('price-change');const ch=cur-prev,pct=((ch/prev)*100).toFixed(2),up=ch>=0;
pEl.textContent=formatPrice(cur).replace('‚Çπ','');pEl.className=`price-display ${up?'up':'down'}`;cEl.textContent=`${up?'+':''}${pct}%`;cEl.className=`price-change ${up?'up':'down'}`}

function toggleOverlay(o){AppState.overlays[o]=!AppState.overlays[o];
switch(o){case'ema9':AppState.ema9Series.applyOptions({visible:AppState.overlays.ema9});break;case'ema21':AppState.ema21Series.applyOptions({visible:AppState.overlays.ema21});break;case'ema50':AppState.ema50Series.applyOptions({visible:AppState.overlays.ema50});break;case'vwap':AppState.vwapSeries.applyOptions({visible:AppState.overlays.vwap});break;case'alerts':AppState.overlays.alerts?addAlertMarkers():AppState.candleSeries.setMarkers([]);break}
document.querySelector(`[data-overlay="${o}"]`).classList.toggle('active',AppState.overlays[o])}

function renderAlerts(alerts){const c=document.getElementById('alert-list');if(!alerts||alerts.length===0){c.innerHTML='<div class="no-data">No alerts available</div>';return}
const fa=alerts.filter(a=>{const s=a.symbol||'';return s===AppState.symbol||s===AppState.symbol+'_FUT'||s.includes(AppState.symbol)}).sort((a,b)=>(b.time||b.timestamp_ist||'').localeCompare(a.time||a.timestamp_ist||''));
if(fa.length===0){c.innerHTML='<div class="no-data">No alerts for '+AppState.symbol+'</div>';return}
c.innerHTML=fa.map((a,i)=>{const t=a.time||a.timestamp_ist||'',act=a.recommended_action||a.alert_type||'UNKNOWN',conf=a.confidence||a.confidence_score||0;const bull=act.includes('BUY_CE')||act.includes('LONG')||act.includes('LB')||act.includes('SC'),bear=act.includes('BUY_PE')||act.includes('SHORT')||act.includes('SB')||act.includes('LU');
return`<div class="alert-item ${bull?'bullish':bear?'bearish':''}" data-index="${i}" onclick="selectAlert(${i})"><div class="alert-header"><span class="alert-time">${formatTime(t)}</span><span class="alert-confidence ${getConfidenceClass(conf)}">${conf}%</span></div><div class="alert-body"><span class="alert-symbol">${a.symbol||AppState.symbol}</span><span class="alert-action ${getActionClass(act)}">${act}</span></div><div class="alert-meta">${a.future_oi_category?`<span class="alert-tag">OI: ${a.future_oi_category}</span>`:''}${a.depth_bias?`<span class="alert-tag">${a.depth_bias}</span>`:''}${a.regime?`<span class="alert-tag">${a.regime}</span>`:''}</div></div>`}).join('');
AppState.alerts=fa}

function selectAlert(i){const a=AppState.alerts[i];if(!a)return;AppState.selectedAlert=a;document.querySelectorAll('.alert-item').forEach((el,idx)=>el.classList.toggle('selected',idx===i));showAlertDetail(a)}

function showAlertDetail(a){document.getElementById('alert-detail-empty').classList.add('hidden');document.getElementById('alert-detail-content').classList.add('visible');const act=a.recommended_action||a.alert_type||'UNKNOWN';
document.getElementById('detail-symbol').textContent=a.symbol||AppState.symbol;document.getElementById('detail-time').textContent=formatDateTime(a.time||a.timestamp_ist);
const ae=document.getElementById('detail-action');ae.textContent=act;ae.className=`detail-action ${getActionClass(act)}`;
document.getElementById('detail-confidence').textContent=(a.confidence||a.confidence_score||0)+'%';document.getElementById('detail-priority').textContent=a.priority||'MEDIUM';document.getElementById('detail-oi').textContent=a.future_oi_category||a.oi_category||'N/A';document.getElementById('detail-depth').textContent=a.depth_bias||'N/A';document.getElementById('detail-regime').textContent=a.regime||'N/A';document.getElementById('detail-vix').textContent=a.vix_state||'N/A';
document.getElementById('detail-message').textContent=a.message||a.metadata||'No additional context available.'}

function updateContext(d){if(!d)return;const dir=d.market_direction||{};document.getElementById('ctx-direction').textContent=dir.direction||'NEUTRAL';document.getElementById('ctx-direction').className=`context-value ${getContextClass(dir.direction)}`;
const an=(d.analytics||[]).find(a=>a.symbol===AppState.symbol||a.symbol===AppState.symbol+'_FUT');
if(an){document.getElementById('ctx-regime').textContent=an.market_regime||'RANGING';document.getElementById('ctx-regime').className=`context-value ${getContextClass(an.market_regime)}`;document.getElementById('ctx-vix').textContent=an.vix_state||'NORMAL';document.getElementById('ctx-vix').className=`context-value ${getContextClass(an.vix_state)}`;
const r=an.bid_ask_ratio||1;let db='NEUTRAL';if(r>=1.5)db='BUYER';else if(r<=0.67)db='SELLER';document.getElementById('ctx-depth').textContent=db;document.getElementById('ctx-depth').className=`context-value ${getContextClass(db)}`;
const conf=an.bullish_percentage||50;document.getElementById('ctx-confidence').textContent=conf.toFixed(0)+'%';const sb=document.getElementById('strength-bar');sb.style.width=conf+'%';sb.className=`strength-bar ${conf>=60?'high':conf>=40?'medium':'low'}`;
updateTradeDecision(an,dir);const vb=document.getElementById('vix-badge'),vv=an.vix_value||15;vb.textContent=vv.toFixed(1);vb.className=`vix-badge ${vv<12?'vix-low':vv>=18?'vix-extreme':vv>=15?'vix-high':'vix-normal'}`}
const sec=d.sectors||[],bk=sec.find(s=>s.sector_name==='BANKING'),nb=sec.find(s=>s.sector_name==='NBFC');
if(bk){document.getElementById('ctx-banking').textContent=bk.signal||'NEUTRAL';document.getElementById('ctx-banking').className=`context-value ${getContextClass(bk.signal)}`}
if(nb){document.getElementById('ctx-nbfc').textContent=nb.signal||'NEUTRAL';document.getElementById('ctx-nbfc').className=`context-value ${getContextClass(nb.signal)}`}}

function updateTradeDecision(an,dir){const de=document.getElementById('trade-decision'),conf=an.bullish_percentage||50,reg=an.market_regime||'RANGING',vix=an.vix_state||'NORMAL',dv=dir.direction||'NEUTRAL';let dec='WAIT',dc='wait';
if(vix==='EXTREME'){dec='AVOID - High VIX';dc='avoid'}else if(reg==='HIGH_VOLATILITY'){dec='CAUTION';dc='wait'}else if(conf>=65&&(dv.includes('BUY')||reg==='TRENDING_UP')){dec='TRADE - Bullish';dc='trade'}else if(conf<=35&&(dv.includes('SELL')||reg==='TRENDING_DOWN')){dec='TRADE - Bearish';dc='trade'}else if(conf>=55||conf<=45){dec='CONSIDER';dc='wait'}
de.textContent=dec;de.className=`decision-value ${dc}`}

function updateSessionAnalytics(alerts){if(!alerts||alerts.length===0){document.getElementById('stat-total-alerts').textContent='0';document.getElementById('stat-avg-confidence').textContent='0%';document.getElementById('stat-buy-alerts').textContent='0';document.getElementById('stat-sell-alerts').textContent='0';return}
const sa=alerts.filter(a=>{const s=a.symbol||'';return s===AppState.symbol||s.includes(AppState.symbol)});const tot=sa.length,avg=sa.reduce((s,a)=>s+(a.confidence||a.confidence_score||0),0)/tot;
let bc=0,sc=0,bce=0,bpe=0,sp=0,wc=0;sa.forEach(a=>{const act=(a.recommended_action||a.alert_type||'').toUpperCase();if(act.includes('BUY_CE')||act.includes('LB')||act.includes('SC')){bc++;bce++}else if(act.includes('BUY_PE')||act.includes('SB')||act.includes('LU')){sc++;bpe++}else if(act.includes('SELL')){sp++}else{wc++}});
document.getElementById('stat-total-alerts').textContent=tot;document.getElementById('stat-avg-confidence').textContent=avg.toFixed(0)+'%';document.getElementById('stat-buy-alerts').textContent=bc;document.getElementById('stat-sell-alerts').textContent=sc;
document.getElementById('legend-buy-ce').textContent=bce;document.getElementById('legend-buy-pe').textContent=bpe;document.getElementById('legend-sell').textContent=sp;document.getElementById('legend-wait').textContent=wc;
drawDistributionChart(bce,bpe,sp,wc);document.getElementById('session-date').textContent=getTodayDate()}

function drawDistributionChart(bce,bpe,sell,wait){const cv=document.getElementById('distribution-canvas'),ctx=cv.getContext('2d'),tot=bce+bpe+sell+wait;ctx.clearRect(0,0,80,80);
if(tot===0){ctx.fillStyle='#374151';ctx.beginPath();ctx.arc(40,40,35,0,Math.PI*2);ctx.fill();return}
const data=[{value:bce,color:'#10b981'},{value:bpe,color:'#ef4444'},{value:sell,color:'#f59e0b'},{value:wait,color:'#6b7280'}];let sa=-Math.PI/2;
data.forEach(seg=>{if(seg.value===0)return;const sl=(seg.value/tot)*Math.PI*2;ctx.beginPath();ctx.moveTo(40,40);ctx.arc(40,40,35,sa,sa+sl);ctx.closePath();ctx.fillStyle=seg.color;ctx.fill();sa+=sl});
ctx.beginPath();ctx.arc(40,40,20,0,Math.PI*2);ctx.fillStyle='#1a1f2e';ctx.fill()}

function initPaperTrading(){const isR=AppState.mode==='replay';document.getElementById('paper-mode-label').textContent=isR?'SIMULATION':'DISABLED';document.getElementById('paper-trade-disabled').classList.toggle('hidden',isR);
document.getElementById('btn-buy-ce').disabled=!isR;document.getElementById('btn-buy-pe').disabled=!isR;document.getElementById('btn-exit').disabled=true;
if(isR){document.getElementById('btn-buy-ce').onclick=()=>simulateTrade('LONG_CE');document.getElementById('btn-buy-pe').onclick=()=>simulateTrade('LONG_PE');document.getElementById('btn-exit').onclick=()=>exitSimulatedTrade()}
updatePaperTradeUI()}

function simulateTrade(pos){if(AppState.paperTrade.position)return;const cc=AppState.replay.data[AppState.replay.currentIndex];if(!cc)return;
AppState.paperTrade.position=pos;AppState.paperTrade.entryPrice=cc.close;AppState.paperTrade.entryTime=cc.time_minute||cc.time;updatePaperTradeUI()}

function exitSimulatedTrade(){if(!AppState.paperTrade.position)return;const cc=AppState.replay.data[AppState.replay.currentIndex];if(!cc)return;const ep=cc.close,pnl=calcPnL(AppState.paperTrade.entryPrice,ep,AppState.paperTrade.position);
AppState.paperTrade.trades.push({position:AppState.paperTrade.position,entryPrice:AppState.paperTrade.entryPrice,entryTime:AppState.paperTrade.entryTime,exitPrice:ep,exitTime:cc.time_minute||cc.time,pnl:pnl});
AppState.paperTrade.position=null;AppState.paperTrade.entryPrice=0;AppState.paperTrade.entryTime=null;updatePaperTradeUI()}

function calcPnL(entry,cur,pos){const d=cur-entry;return pos==='LONG_CE'?d:-d}

function updatePaperTradeUI(){const pos=AppState.paperTrade.position,posEl=document.getElementById('paper-position'),etEl=document.getElementById('paper-entry-time'),epEl=document.getElementById('paper-entry-price'),cpEl=document.getElementById('paper-current-price'),pnlEl=document.getElementById('paper-pnl');
const bce=document.getElementById('btn-buy-ce'),bpe=document.getElementById('btn-buy-pe'),bex=document.getElementById('btn-exit');
if(pos){posEl.textContent=pos==='LONG_CE'?'LONG CE':'LONG PE';posEl.className=`trade-position ${pos==='LONG_CE'?'long':'short'}`;etEl.textContent=formatTime(AppState.paperTrade.entryTime);epEl.textContent=formatPrice(AppState.paperTrade.entryPrice);
const cc=AppState.replay.data[AppState.replay.currentIndex],cp=cc?cc.close:AppState.paperTrade.entryPrice;cpEl.textContent=formatPrice(cp);const pnl=calcPnL(AppState.paperTrade.entryPrice,cp,pos);pnlEl.textContent=formatPnL(pnl);pnlEl.className=`trade-pnl ${pnl>=0?'profit':'loss'}`;
bce.classList.add('hidden');bpe.classList.add('hidden');bex.classList.remove('hidden');bex.disabled=false}else{posEl.textContent='NO POSITION';posEl.className='trade-position flat';etEl.textContent='--';epEl.textContent='--';cpEl.textContent='--';pnlEl.textContent='‚Çπ0';pnlEl.className='trade-pnl';
bce.classList.remove('hidden');bpe.classList.remove('hidden');bex.classList.add('hidden');if(AppState.mode==='replay'){bce.disabled=false;bpe.disabled=false}}}

function setMode(m){AppState.mode=m;document.querySelectorAll('.mode-btn').forEach(b=>b.classList.toggle('active',b.dataset.mode===m));document.getElementById('datetime-picker').classList.toggle('visible',m==='replay');document.getElementById('replay-controls').classList.toggle('visible',m==='replay');
document.getElementById('status-dot').classList.toggle('replay',m==='replay');initPaperTrading();m==='live'?startLivePolling():stopLivePolling()}

function startLivePolling(){stopLivePolling();fetchLiveData();AppState.pollTimer=setInterval(fetchLiveData,CONFIG.LIVE_POLL_INTERVAL)}
function stopLivePolling(){if(AppState.pollTimer){clearInterval(AppState.pollTimer);AppState.pollTimer=null}}

async function fetchLiveData(){try{const sum=await fetchDashboardSummary();
if(sum){AppState.isConnected=true;AppState.lastUpdate=new Date();document.getElementById('status-dot').classList.remove('offline');document.getElementById('status-text').textContent='Connected';document.getElementById('last-update').textContent=AppState.lastUpdate.toLocaleTimeString('en-IN');
AppState.analytics=sum.analytics;AppState.marketDirection=sum.market_direction;AppState.sectors=sum.sectors;updateContext(sum);
if(sum.recent_alerts){AppState.alerts=sum.recent_alerts;renderAlerts(sum.recent_alerts);updateSessionAnalytics(sum.recent_alerts)}}
const cd=await fetchCandles(AppState.symbol,6);if(cd&&cd.length>0){AppState.candles=cd;updateChart(cd,AppState.analytics)}}catch(e){console.error('Live data fetch error:',e);AppState.isConnected=false;document.getElementById('status-dot').classList.add('offline');document.getElementById('status-text').textContent='Disconnected'}}

async function loadReplayData(){const dt=document.getElementById('replay-date').value,ft=document.getElementById('replay-from').value,tt=document.getElementById('replay-to').value;if(!dt){alert('Please select a date');return}
const from=`${dt} ${ft}:00`,to=`${dt} ${tt}:00`;document.getElementById('status-text').textContent='Loading...';
try{const cd=await fetchCandles(AppState.symbol,8);if(!cd||cd.length===0){alert('No data available for selected date');return}
const fc=cd.filter(c=>{const t=c.time_minute||c.time;return t>=from&&t<=to});if(fc.length===0){alert('No data in selected time range');return}
const al=await fetchAlertsByTime(from,to);AppState.replay.data=fc;AppState.replay.currentIndex=0;AppState.alerts=al||[];AppState.paperTrade.position=null;AppState.paperTrade.trades=[];
renderAlerts(al);updateSessionAnalytics(al);updateReplayChart();updateReplayTime();initPaperTrading();document.getElementById('status-text').textContent='Replay Ready'}catch(e){console.error('Replay load error:',e);document.getElementById('status-text').textContent='Load Failed'}}

function updateReplayChart(){if(!AppState.replay.data||AppState.replay.data.length===0)return;const vc=AppState.replay.data.slice(0,AppState.replay.currentIndex+1);updateChart(vc);updatePaperTradeUI()}
function updateReplayTime(){const cc=AppState.replay.data[AppState.replay.currentIndex];if(cc)document.getElementById('replay-time').textContent=formatTime(cc.time_minute||cc.time)}

function replayStep(dir){const mx=AppState.replay.data.length-1;if(dir==='start')AppState.replay.currentIndex=0;else if(dir==='end')AppState.replay.currentIndex=mx;else if(dir==='prev'&&AppState.replay.currentIndex>0)AppState.replay.currentIndex--;else if(dir==='next'&&AppState.replay.currentIndex<mx)AppState.replay.currentIndex++;updateReplayChart();updateReplayTime()}

function toggleReplayPlay(){if(AppState.replay.isPlaying){AppState.replay.isPlaying=false;if(AppState.replay.playInterval){clearInterval(AppState.replay.playInterval);AppState.replay.playInterval=null}document.getElementById('replay-play').textContent='‚ñ∂ Play'}else{AppState.replay.isPlaying=true;document.getElementById('replay-play').textContent='‚è∏ Pause';const sp=parseInt(document.getElementById('replay-speed').value);
AppState.replay.playInterval=setInterval(()=>{if(AppState.replay.currentIndex<AppState.replay.data.length-1){AppState.replay.currentIndex++;updateReplayChart();updateReplayTime()}else{toggleReplayPlay()}},sp)}}

function initEventListeners(){document.querySelectorAll('.symbol-btn').forEach(b=>b.addEventListener('click',()=>{document.querySelectorAll('.symbol-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');AppState.symbol=b.dataset.symbol;document.getElementById('chart-symbol').textContent=AppState.symbol;AppState.mode==='live'?fetchLiveData():(renderAlerts(AppState.alerts),updateSessionAnalytics(AppState.alerts))}));
document.querySelectorAll('.mode-btn').forEach(b=>b.addEventListener('click',()=>setMode(b.dataset.mode)));
document.querySelectorAll('.overlay-btn').forEach(b=>b.addEventListener('click',()=>toggleOverlay(b.dataset.overlay)));
document.querySelectorAll('.panel-tab').forEach(t=>t.addEventListener('click',()=>{document.querySelectorAll('.panel-tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.panel-content').forEach(p=>p.classList.remove('active'));t.classList.add('active');document.getElementById(`panel-${t.dataset.panel}`).classList.add('active')}));
document.getElementById('load-replay-btn').addEventListener('click',loadReplayData);document.getElementById('replay-start').addEventListener('click',()=>replayStep('start'));document.getElementById('replay-prev').addEventListener('click',()=>replayStep('prev'));document.getElementById('replay-play').addEventListener('click',toggleReplayPlay);document.getElementById('replay-next').addEventListener('click',()=>replayStep('next'));document.getElementById('replay-end').addEventListener('click',()=>replayStep('end'));
document.getElementById('replay-speed').addEventListener('change',()=>{if(AppState.replay.isPlaying){toggleReplayPlay();toggleReplayPlay()}});document.getElementById('replay-date').value=getTodayDate()}

function init(){console.log('Initializing Trading Dashboard...');console.log('API Base:',CONFIG.API_BASE);initChart();initEventListeners();initPaperTrading();setMode('live');drawDistributionChart(0,0,0,0);console.log('Dashboard initialized')}
document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init();
    </script>
</body>
</html>
